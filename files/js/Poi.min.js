var Poi={};Poi.Category={};Poi.Map={};Poi.Map.GoogleMaps={};Poi.Poi={};Poi.Poi.Coordinates={};Poi.Category.MarkAllAsRead=Class.extend({_callback:null,_proxy:null,init:function(a){this._callback=a;this._proxy=new WCF.Action.Proxy({success:$.proxy(this._success,this)});$(".markAllAsReadButton").click($.proxy(this._click,this))},_click:function(a){a.preventDefault();this._proxy.setOption("data",{actionName:"markAllAsRead",className:"poi\\data\\category\\PoiCategoryAction"});this._proxy.sendRequest()},_success:function(d,e,c){if(this._callback&&$.isFunction(this._callback)){return this._callback()}var a=$(".nestedCategoryList");a.find(".badge.badgeUpdate").hide();$(".mainMenu .active .badge").hide();var b=new WCF.System.Notification(WCF.Language.get("wcf.global.success"),"success");b.show()}});Poi.Poi.Clipboard=Class.extend({_categoryID:0,_environment:"category",_updateHandler:null,init:function(b,a,c){this._updateHandler=b;this._environment=a;this._categoryID=(c)?c:0;require(["EventHandler"],function(d){d.add("com.woltlab.wcf.clipboard","com.uz.poi.poi",this._clipboardAction.bind(this))}.bind(this))},_clipboardAction:function(b){if(b.responseData&&b.responseData.returnValues&&b.responseData.returnValues.poiData){var a=b.responseData.returnValues.poiData;for(var c in a){if(a.hasOwnProperty(c)){this._updateHandler.update(c,a[c])}}}}});Poi.Poi.InlineEditor=WCF.InlineEditor.extend({_environment:"poi",_permissions:{},_redirectURL:"",_updateHandler:null,_setOptions:function(){this._environment="poi";this._options=[{label:WCF.Language.get("poi.poi.edit.enable"),optionName:"enable"},{label:WCF.Language.get("poi.poi.edit.disable"),optionName:"disable"},{label:WCF.Language.get("poi.poi.edit.trash"),optionName:"trash"},{label:WCF.Language.get("poi.poi.edit.restore"),optionName:"restore"},{label:WCF.Language.get("poi.poi.edit.delete"),optionName:"delete"},{optionName:"divider"},{label:WCF.Language.get("poi.poi.edit.setAsFeatured"),optionName:"setAsFeatured"},{label:WCF.Language.get("poi.poi.edit.unsetAsFeatured"),optionName:"unsetAsFeatured"},{optionName:"divider"},{label:WCF.Language.get("wcf.global.button.edit"),optionName:"edit",isQuickOption:true}]},setUpdateHandler:function(a){this._updateHandler=a},_getTriggerElement:function(a){return a.find(".jsPoiInlineEditor")},_show:function(b){var c=$(b.currentTarget).data("elementID");var a=null;if(!this._dropdowns[c]){a=this._getTriggerElement(this._elements[c]).addClass("dropdownToggle");a.parent().addClass("dropdown");this._dropdowns[c]=$('<ul class="dropdownMenu" />').insertAfter(a)}this._super(b);if(a!==null){WCF.Dropdown.initDropdown(a,true)}return false},_validate:function(a,c){var b=$("#"+a).data("poiID");switch(c){case"delete":if(!this._getPermission("canDeletePoiCompletely")){return false}return(this._updateHandler.getValue(b,"isDeleted"));break;case"restore":if(!this._getPermission("canRestorePoi")){return false}return(this._updateHandler.getValue(b,"isDeleted"));break;case"trash":if(!this._getPermission("canDeletePoi")){return false}return !(this._updateHandler.getValue(b,"isDeleted"));break;case"enable":if(!this._getPermission("canEnablePoi")){return false}if(this._updateHandler.getValue(b,"isDeleted")){return false}return(this._updateHandler.getValue(b,"isDisabled"));break;case"disable":if(!this._getPermission("canEnablePoi")){return false}if(this._updateHandler.getValue(b,"isDeleted")){return false}return !(this._updateHandler.getValue(b,"isDisabled"));break;case"setAsFeatured":if(!this._getPermission("canSetAsFeatured")){return false}return !(this._updateHandler.getValue(b,"isFeatured"));break;case"unsetAsFeatured":if(!this._getPermission("canSetAsFeatured")){return false}return(this._updateHandler.getValue(b,"isFeatured"));break;case"edit":return true;break}return false},_execute:function(a,c){if(!this._validate(a,c)){return false}switch(c){case"enable":case"disable":this._updatePoi(a,c,{isDisabled:(c==="enable"?0:1)});break;case"delete":var b=this;WCF.System.Confirmation.show(WCF.Language.get("poi.poi.confirmDelete"),function(d){if(d==="confirm"){b._updatePoi(a,c,{deleted:1})}});break;case"restore":this._updatePoi(a,c,{isDeleted:0});break;case"trash":var b=this;WCF.System.Confirmation.show(WCF.Language.get("poi.poi.confirmTrash"),function(d){if(d==="confirm"){b._updatePoi(a,c,{isDeleted:1,reason:$("#wcfSystemConfirmationContent").find("textarea").val()})}},{},$('<div class="section"><dl><dt><label for="poiDeleteReason">'+WCF.Language.get("poi.poi.confirmTrash.reason")+'</label></dt><dd><textarea id="poiDeleteReason" cols="40" rows="4" /></dd></dl></div>'));break;case"setAsFeatured":case"unsetAsFeatured":this._updatePoi(a,c,{isFeatured:(c==="setAsFeatured"?1:0)});break;case"edit":window.location=this._getTriggerElement($("#"+a)).prop("href");break;default:return false;break}return true},_updatePoi:function(a,d,e){if(d==="delete"){var b=this;var c=this._elements[a].data("poiID");new WCF.Action.Proxy({autoSend:true,data:{actionName:d,className:"poi\\data\\poi\\PoiAction",objectIDs:[c]},success:function(f){b._updateHandler.update(c,f.returnValues.poiData[c])}})}else{this._updateData.push({data:e,elementID:a,optionName:d});this._proxy.setOption("data",{actionName:d,className:"poi\\data\\poi\\PoiAction",objectIDs:[this._elements[a].data("poiID")],parameters:{data:e}});this._proxy.sendRequest()}},_updateState:function(){if(this._environment=="poi"&&this._updateData.length==1&&this._updateData[0].optionName=="trash"&&!this._getPermission("canViewDeletedPoi")){this._notification.show($.proxy(function(){window.location=this._redirectURL},this));return}this._notification.show();for(var d=0,c=this._updateData.length;d<c;d++){var a=this._updateData[d];var b=$("#"+a.elementID).data("poiID");this._updateHandler.update(b,a.data)}},_getPermission:function(a){if(this._permissions[a]){return this._permissions[a]}return 0},setEnvironment:function(a,b){if(a!=="category"){a="poi"}this._environment=a;this._redirectURL=b},setPermission:function(a,b){this._permissions[a]=b},setPermissions:function(a){for(var b in a){this.setPermission(b,a[b])}}});Poi.Poi.UpdateHandler=Class.extend({_pois:{},init:function(){var a=this;$(".poiPoi").each(function(c,d){var b=$(d);a._pois[b.data("objectID")]=b})},update:function(c,b){if(!this._pois[c]){console.debug("[Poi.Poi.UpdateHandler] Unknown poi id "+c);return}for(var a in b){this._updateProperty(c,a,b[a])}},_updateProperty:function(c,b,a){switch(b){case"deleted":this._delete(c,a);break;case"isDeleted":if(a){this._trash(c)}else{this._restore(c)}break;case"isDisabled":if(a){this._disable(c)}else{this._enable(c)}break;case"isFeatured":if(a){this._setAsFeatured(c)}else{this._unsetAsFeatured(c)}break;default:this._handleCustomProperty(c,b,a);break}},_handleCustomProperty:function(c,b,a){this._pois[c].trigger("poiUpdateHandlerProperty",[c,b,a])},_delete:function(b,a){},_disable:function(a){this._pois[a].data("isDisabled",1)},_enable:function(a){this._pois[a].data("isDisabled",0)},_restore:function(a){this._pois[a].data("isDeleted",0)},_setAsFeatured:function(a){this._pois[a].data("isFeatured",1)},_trash:function(a){this._pois[a].data("isDeleted",1)},_unsetAsFeatured:function(a){this._pois[a].data("isFeatured",0)},getValue:function(b,a){if(!this._pois[b]){console.debug("[Poi.Poi.UpdateHandler] Unknown poi id "+b);return}switch(a){case"isDeleted":return this._pois[b].data("isDeleted");break;case"isDisabled":return this._pois[b].data("isDisabled");break;case"isFeatured":return this._pois[b].data("isFeatured");break}}});Poi.Poi.UpdateHandler.Category=Poi.Poi.UpdateHandler.extend({_delete:function(b,a){this._pois[b].remove();delete this._pois[b];WCF.Clipboard.reload()},_disable:function(a){this._super(a);this._pois[a].addClass("messageDisabled")},_enable:function(a){this._super(a);this._pois[a].removeClass("messageDisabled")},_restore:function(b){this._super(b);this._pois[b].removeClass("messageDeleted");this._pois[b].find(".poiDeleteNote").remove();var c=elByClass("poi"+b);var a=c[0].getAttribute("data-is-disabled");if(a=="1"){this._pois[b].addClass("messageDisabled")}},_setAsFeatured:function(a){this._super(a);$('<span class="badge label green jsLabelFeatured">'+WCF.Language.get("poi.poi.featured")+"</span>").appendTo(this._pois[a].find(".poiListPoiIcon"))},_trash:function(a){this._super(a);this._pois[a].removeClass("messageDisabled");this._pois[a].addClass("messageDeleted")},_unsetAsFeatured:function(a){this._super(a);this._pois[a].find(".jsLabelFeatured").remove()}});Poi.Poi.UpdateHandler.Poi=Poi.Poi.UpdateHandler.extend({update:function(b,a){var c=this._pois[b];if(this._pois[b]){if(a.isDeleted!==undefined&&!a.isDeleted){this._restore(b,true);delete a.isDeleted}if(a.isDisabled!==undefined&&!a.isDisabled){this._enable(b,true);delete a.isDisabled}}this._super(b,a)},_delete:function(b,a){new WCF.PeriodicalExecuter(function(c){c.stop();window.location=a},1000)},_disable:function(a){this._super(a);this._pois[a].addClass("messageDisabled")},_enable:function(a){this._super(a);this._pois[a].removeClass("messageDisabled")},_restore:function(d,c){this._super(d);this._pois[d].removeClass("messageDeleted");var b=elById("poiDeleteNoteDiv");b.innerHTML="";var e=elByClass("poi"+d);var a=e[0].getAttribute("data-is-disabled");if(a=="true"){this._pois[d].addClass("messageDisabled")}},_setAsFeatured:function(a){this._super(a);$('<span class="badge label green jsLabelFeatured">'+WCF.Language.get("poi.poi.featured")+"</span>").prependTo($(".poiPoi .contentTitle"))},_trash:function(b){this._super(b);this._pois[b].removeClass("messageDisabled");this._pois[b].addClass("messageDeleted");var a=elById("poiDeleteNoteDiv");a.innerHTML='<div class="section"><p class="poiPoiDeleteNote">'+WCF.Language.get("poi.poi.log.poi.trash.summary.js")+"</p></div>"},_unsetAsFeatured:function(a){this._super(a);$(".jsLabelFeatured").remove()}});Poi.Poi.Preview=WCF.Popover.extend({_proxy:null,init:function(){this._super(".poiPoiLink");this._proxy=new WCF.Action.Proxy({showLoadingOverlay:false});WCF.DOMNodeInsertedHandler.addCallback("Poi.Poi.Preview",$.proxy(this._initContainers,this))},_loadContent:function(){var b=$("#"+this._activeElementID);this._proxy.setOption("data",{actionName:"getPoiPreview",className:"poi\\data\\poi\\PoiAction",objectIDs:[b.data("poiID")]});var c=this._activeElementID;var a=this;this._proxy.setOption("success",function(e,f,d){a._insertContent(c,e.returnValues.template,true)});this._proxy.sendRequest()}});Poi.Poi.WatchedPoiList=Class.extend({_button:null,_markAllCheckbox:null,init:function(){this._button=$("#stopWatchingButton").click($.proxy(this._stopWatching,this));this._markAllCheckbox=$(".jsMarkAllWatchedPois").change($.proxy(this._markAll,this));$(".jsWatchedPoi").change($.proxy(this._mark,this))},_mark:function(a){$(a.target).parents("tr").toggleClass("jsMarked");if(this._markAllCheckbox.is(":checked")){this._markAllCheckbox.prop("checked",false)}else{this._markAllCheckbox.prop("checked",$(".jsWatchedPoi:not(:checked)").length==0)}this._updateButtonLabel()},_markAll:function(a){$(".jsWatchedPoi").prop("checked",this._markAllCheckbox.prop("checked")).parents("tr").toggleClass("jsMarked",this._markAllCheckbox.prop("checked"));this._updateButtonLabel()},_stopWatching:function(b){var e=$(".jsWatchedPoi:checked");var a=[];var c=false;if(e.length){e.each(function(f,g){a.push($(g).data("objectID"))})}else{c=true}var d="poi.poi.watchedPois.stopWatchingMarked.confirmMessage";if(c){d="poi.poi.watchedPois.stopWatchingAll.confirmMessage"}WCF.System.Confirmation.show(WCF.Language.get(d),function(f){if(f==="confirm"){new WCF.Action.Proxy({autoSend:true,data:{actionName:"stopWatching",className:"poi\\data\\poi\\PoiAction",parameters:{stopWatchingAll:c,poiIDs:a}},success:function(){window.location.reload()}})}})},_updateButtonLabel:function(){var b=$(".jsWatchedPoi:checked");var a="";if(b.length){a=WCF.Language.get("poi.poi.watchedPois.stopWatchingMarked",{count:b.length})}else{a=WCF.Language.get("poi.poi.watchedPois.stopWatchingAll")}this._button.html(a)}});Poi.Poi.Coordinates.Handler=Class.extend({_form:null,_locationInput:null,init:function(a){this._locationInput=a;this._form=$("#messageContainer").submit($.proxy(this._submit,this))},_submit:function(a){if(this._form.data("geocodingCompleted")){return true}var b=$.trim($("#geocode").val());if(!b){WCF.Location.GoogleMaps.Util.reverseGeocoding($.proxy(this._reverseGeocoding,this),this._locationInput.getMarker());a.preventDefault();return false}this._setCoordinates()},_reverseGeocoding:function(a){$("#geocode").val(a);this._setCoordinates();this._form.trigger("submit")},_setCoordinates:function(){var a=this._form.find(".formSubmit");$('<input type="hidden" name="latitude" value="'+this._locationInput.getMarker().getPosition().lat()+'" />').appendTo(a);$('<input type="hidden" name="longitude" value="'+this._locationInput.getMarker().getPosition().lng()+'" />').appendTo(a);this._form.data("geocodingCompleted",true)}});Poi.Map.GoogleMaps.Settings={_settings:{},get:function(a){if(a===undefined){return this._settings}if(this._settings[a]!==undefined){return this._settings[a]}return null},set:function(b,c){if($.isPlainObject(b)){for(var a in b){this._settings[a]=b[a]}}else{this._settings[b]=c}}};Poi.Map.GoogleMaps.Map=Class.extend({_map:null,_markers:[],_infoWindows:[],init:function(b,a){this._mapContainer=$("#"+b);this._mapOptions=$.extend(true,this._getDefaultMapOptions(),a);this._map=new google.maps.Map(this._mapContainer[0],this._mapOptions);this._markers=[];this._infoWindows=[];if(this._mapContainer.parents(".sidebar").length){enquire.register("(max-width: 767px)",{setup:$.proxy(this._addSidebarMapListener,this),deferSetup:true})}this.refresh()},_addInfoWindowEventListener:function(a,b){google.maps.event.addListener(a,"click",$.proxy(function(){b.open(this._map,a)},this))},_addSidebarMapListener:function(){$(".content > .mobileSidebarToggleButton").click($.proxy(this.refresh,this))},_getDefaultMapOptions:function(){var a={};a.center=new google.maps.LatLng(Poi.Map.GoogleMaps.Settings.get("defaultLatitude"),Poi.Map.GoogleMaps.Settings.get("defaultLongitude"));a.disableDoubleClickZoom=Poi.Map.GoogleMaps.Settings.get("disableDoubleClickZoom");a.draggable=Poi.Map.GoogleMaps.Settings.get("draggable");switch(Poi.Map.GoogleMaps.Settings.get("mapType")){case"map":a.mapTypeId=google.maps.MapTypeId.ROADMAP;break;case"satellite":a.mapTypeId=google.maps.MapTypeId.SATELLITE;break;case"physical":a.mapTypeId=google.maps.MapTypeId.TERRAIN;break;case"hybrid":default:a.mapTypeId=google.maps.MapTypeId.HYBRID;break}a.mapTypeControl=Poi.Map.GoogleMaps.Settings.get("mapTypeControl")!="off";if(a.mapTypeControl){switch(Poi.Map.GoogleMaps.Settings.get("mapTypeControl")){case"dropdown":a.mapTypeControlOptions={style:google.maps.MapTypeControlStyle.DROPDOWN_MENU};break;case"horizontalBar":a.mapTypeControlOptions={style:google.maps.MapTypeControlStyle.HORIZONTAL_BAR};break;default:a.mapTypeControlOptions={style:google.maps.MapTypeControlStyle.DEFAULT};break}}a.scaleControl=Poi.Map.GoogleMaps.Settings.get("scaleControl");a.scrollwheel=Poi.Map.GoogleMaps.Settings.get("scrollwheel");a.zoom=Poi.Map.GoogleMaps.Settings.get("zoom");return a},addDraggableMarker:function(c,b){var a=new google.maps.Marker({clickable:false,draggable:true,map:this._map,position:new google.maps.LatLng(c,b),zIndex:1});this._markers.push(a);return a},addMarker:function(g,e,f,d,c){var b=new google.maps.Marker({map:this._map,position:new google.maps.LatLng(g,e),title:f});if(d){b.setIcon(d)}if(c){var a=new google.maps.InfoWindow({content:c,maxWidth:350});this._addInfoWindowEventListener(b,a);b.infoWindow=a;this._infoWindows.push(a)}this._markers.push(b);return b},getMarkers:function(){return this._markers},getMap:function(){return this._map},refresh:function(){var a=this._map.getCenter();google.maps.event.trigger(this._map,"resize");this._map.setCenter(a)},refreshBounds:function(){var f=null;var c=null;var d=null;var g=null;for(var a in this._markers){var e=this._markers[a];var h=e.getPosition().lat();var b=e.getPosition().lng();if(f===null){f=c=h;d=g=b}else{if(f>h){f=h}else{if(c<h){c=h}}if(d>h){d=h}else{if(g<b){g=b}}}}this._map.fitBounds(new google.maps.LatLngBounds(new google.maps.LatLng(f,d),new google.maps.LatLng(c,g)))},removeMarkers:function(){for(var a in this._markers){this._markers[a].setMap(null)}this._markers=[]},setBounds:function(a,b){this._map.fitBounds(new google.maps.LatLngBounds(new google.maps.LatLng(b.latitude,b.longitude),new google.maps.LatLng(a.latitude,a.longitude)))},setCenter:function(b,a){this._map.setCenter(new google.maps.LatLng(b,a))}});Poi.Map.LargeMap=Poi.Map.GoogleMaps.Map.extend({_additionalParameters:{},_locationSearch:null,_locationSearchInputSelector:null,_markerClusterer:null,_markersLoaded:false,_bounds:null,_circleLocation:null,_buttonCenter:null,_buttonCleanup:null,_buttonFilter:null,_buttonResetFilter:null,_count:0,_userFilter:null,_poiSearch:"",_categoryID:0,_loadingOverlay:null,_selectedCategories:[],_markerInfoSave:[],_markerOpen:[],_directionsService:null,_directionsDisplay:null,_searchMarker:[],_usedCategories:[],init:function(g,c,f,b,d,e){this._super(g,c);var c=parseInt(c);if(c){var a=[{featureType:"poi",elementType:"labels",stylers:[{visibility:"off"}]}];this._map.setOptions({styles:a})}this._additionalParameters=b||{};this._poiSearch=d;this._categoryID=parseInt(e);this._count=0;this._buttonCenter=$("#centerButton");this._buttonCleanup=$("#cleanupButton");this._buttonFilter=$("#filterButton");this._buttonResetFilter=$("#filterResetButton");this._buttonCenter.disable();this._buttonCleanup.disable();this._buttonFilter.disable();this._buttonResetFilter.disable();this._locationSearchInputSelector=f||"";if(this._locationSearchInputSelector){this._locationSearch=new WCF.Location.GoogleMaps.LocationSearch(f,$.proxy(this._locationList,this))}this._markerClusterer=new MarkerClusterer(this._map,this._markers,{maxZoom:17,imagePath:Poi.Map.GoogleMaps.Settings.get("markerClustererImagePath")+"m"});this._markerSpiderfier=new OverlappingMarkerSpiderfier(this._map,{keepSpiderfied:true,markersWontHide:true,markersWontMove:true});this._markerSpiderfier.addListener("click",$.proxy(function(h){if(h.infoWindow){if(h.infoWindow.getMap()){h.infoWindow.close();var i=this._markerOpen.indexOf(h);if(i>-1){this._markerOpen.splice(i,1)}}else{h.infoWindow.open(this._map,h);this._markerOpen.push(h)}}},this));this._proxy=new WCF.Action.Proxy({showLoadingOverlay:true,success:$.proxy(this._success,this)});google.maps.event.addListener(this._map,"idle",$.proxy(this._loadMarkers,this));$("#searchButton").click($.proxy(this._search,this));$("#routeButton").click($.proxy(this._route,this));this._buttonCenter=$("#centerButton");this._buttonCenter.click($.proxy(this._centerBounds,this));this._buttonCleanup=$("#cleanupButton");this._buttonCleanup.click($.proxy(this._cleanup,this));this._userFilter=$("#userFilter");this._selectedCategories.push(0);this._buttonFilter=$("#filterButton");this._buttonFilter.click($.proxy(this._filter,this));this._buttonResetFilter=$("#filterResetButton");this._buttonResetFilter.click($.proxy(this._filterReset,this));this._buttonResetFilter.hide()},_filterReset:function(){var a=document.getElementsByName("category");if(a.length){for(var b=0;b<a.length;b++){if(!a[b].disabled){a[b].checked=true}}}this._userFilter.val("");this._filter();document.getElementById("filterActive").innerHTML="";this._buttonResetFilter.hide()},_filter:function(){var j=document.getElementsByName("category");var b=[];for(var h=0;h<j.length;h++){if(j[h].checked==true){b.push(parseInt(j[h].value))}}var f=[];var c=0;for(var h=0;h<this._markerInfoSave.length;h++){if(this._userFilter.val()!=""){var a=this._markerInfoSave[h].username.toLocaleUpperCase();var e=this._userFilter.val().toLocaleUpperCase();if(!a.includes(e)){continue}}if(b.length){var i=this._markerInfoSave[h].categoryID;for(var g=0;g<b.length;g++){if(i==parseInt(b[g])){f.push(this._markerInfoSave[h]);c++;break}}}}this._markerClusterer.clearMarkers();this._markerSpiderfier.clearMarkers();this._bounds=null;this._bounds=new google.maps.LatLngBounds();for(var h=0;h<f.length;h++){var d=f[h];this.addMarker(d.latitude,d.longitude,d.title,d.icon,d.infoWindow,d.dialog,d.location);this._bounds.extend(new google.maps.LatLng(d.latitude,d.longitude))}document.getElementById("filterActive").innerHTML=WCF.Language.get("poi.map.filter.active");this._buttonResetFilter.show()},_cleanup:function(){if(this._circleLocation){this._circleLocation.setMap(null);this._circleLocation=null}if(this._searchMarker.length){for(var b=0,a=this._searchMarker.length;b<a;b++){this._searchMarker[b].setMap(null)}this._searchMarker=[]}if(this._markerOpen.length){this._markerOpen=[]}this._filter();if(this._directionsDisplay!==null){this._directionsDisplay.setMap(null);this._directionsDisplay=null}if(this._directionsService!==null){this._directionsService=null}},_route:function(){if(this._directionsDisplay!==null){this._directionsDisplay.setMap(null);this._directionsDisplay=null}if(this._directionsService!==null){this._directionsService=null}if(this._searchMarker.length+this._markerOpen.length<2){$('<header class="boxHeadline">'+WCF.Language.get("poi.map.route.error")+"</header>").wcfDialog({title:WCF.Language.get("wcf.global.error.title")})}else{var a=null;var i=null;var b=0;var c=0;var g=0;var e=[];var d=[];if(this._searchMarker.length){b=0;while(c<25&&b<this._searchMarker.length){g=this._searchMarker[b].getPosition();d.push({location:g,stopover:true});c++;b++}}if(this._markerOpen.length){b=0;while(c<25&&b<this._markerOpen.length){g=this._markerOpen[b].getPosition();d.push({location:g,stopover:true});c++;b++}}if(d.length>1){a=d[0].location;i=d[1].location;d.splice(0,2)}this._directionsService=new google.maps.DirectionsService();this._directionsDisplay=new google.maps.DirectionsRenderer({suppressMarkers:true});this._directionsDisplay.setMap(this.getMap());var f=this._directionsDisplay;var h={origin:a,destination:i,waypoints:d,travelMode:"DRIVING"};this._directionsService.route(h,function(l,m){if(m=="OK"){f.setDirections(l);var q=l.routes[0].legs;var r=l.geocoded_waypoints.length;var k=[];var n=0;var j="";var p="<div><p>"+WCF.Language.get("poi.map.route.found")+"</p><br>";for(var s=0,o=q.length;s<o;s++){if(k.indexOf(q[s].start_address)<0){k.push(q[s].start_address);j+=encodeURIComponent(q[s].start_address)+"/"}if(k.indexOf(q[s].end_address)<0){k.push(q[s].end_address);j+=encodeURIComponent(q[s].end_address)+"/"}n+=q[s].distance.value;p=p.concat("<p>"+q[s].start_address+"</p>");p=p.concat("<p>"+q[s].end_address+"</p>");p=p.concat("<p>"+q[s].distance.text+"</p><br>")}p=p.concat("<p>"+WCF.Language.get("poi.map.route.waypoints")+" "+r+"</p>");p=p.concat("<p>"+WCF.Language.get("poi.map.route.distance")+" "+parseInt(n/1000)+"</p>");p=p.concat('<div class="formSubmit"><a href="https://www.google.com/maps/dir/'+j+' "{if EXTERNAL_LINK_TARGET_BLANK} target="_blank"{/if}{if EXTERNAL_LINK_REL_NOFOLLOW} rel="nofollow"{/if}" class="button" > <span>'+WCF.Language.get("poi.map.route.open")+"</span></a></div>");$("<div>"+p+"</div>").wcfDialog({title:WCF.Language.get("poi.map.route")})}else{$('<header class="boxHeadline">'+WCF.Language.get("poi.map.search.error.direction")+"</header>").wcfDialog({title:WCF.Language.get("wcf.global.error.title")})}})}},_centerBounds:function(){if(Poi.Map.GoogleMaps.Settings.get("centerOnOpen")){if(this._bounds){this.getMap().fitBounds(this._bounds)}}else{this._map.setCenter(new google.maps.LatLng(Poi.Map.GoogleMaps.Settings.get("defaultLatitude"),Poi.Map.GoogleMaps.Settings.get("defaultLongitude")));this._map.setZoom(Poi.Map.GoogleMaps.Settings.get("zoom"))}},_search:function(){var b=document.getElementById("geocode").value;if(!b){$('<header class="boxHeadline">'+WCF.Language.get("poi.map.search.error.empty")+"</header>").wcfDialog({title:WCF.Language.get("wcf.global.error.title")})}else{var a=new WCF.Action.Proxy({autoSend:true,showLoadingOverlay:true,data:{actionName:"search",className:"poi\\data\\poi\\PoiAction",parameters:{location:b},},success:$.proxy(this._searchSuccess,this)})}},_searchSuccess:function(e,a,j){var f=document.getElementById("geocode").value;var c=e.returnValues;if(f){if(typeof c.locationLat=="undefined"){$('<header class="boxHeadline">'+WCF.Language.get("poi.map.search.error.locationNotFound")+"</header>").wcfDialog({title:WCF.Language.get("wcf.global.error.title")})}}else{if(typeof c.locationLat==="undefined"){$('<header class="boxHeadline">'+WCF.Language.get("poi.map.search.error.locationNotFound")+"</header>").wcfDialog({title:WCF.Language.get("wcf.global.error.title")})}}var m=0;if(f&&typeof c.locationLat!=="undefined"){if(this._circleLocation){this._circleLocation.setMap(null);this._circleLocation=null}this._circleLocation=new google.maps.Circle({strokeColor:"#FF0000",strokeOpacity:0.8,strokeWeight:1,fillColor:"#FF0000",fillOpacity:0.1,map:this._map,center:new google.maps.LatLng(c.locationLat,c.locationLng),radius:2500,editable:false,visible:true});this._bounds.extend(new google.maps.LatLng(c.locationLat,c.locationLng));m=1;var b={lat:c.locationLat,lng:c.locationLng};var l=0;if(this._searchMarker.length){for(var k=0,i=this._searchMarker.length;k<i;k++){var g=this._searchMarker[k].getPosition().lat();var h=this._searchMarker[k].getPosition().lng();g=g.toFixed(7);h=h.toFixed(7);if(g==b.lat&&h==b.lng){l=1;break}}}if(l==0){var d=new google.maps.Marker({position:new google.maps.LatLng(b.lat,b.lng),map:this._map,icon:c.icon,title:f,zIndex:999999});d.setMap(this._map);this._searchMarker.push(d)}}if(m){this._map.fitBounds(this._circleLocation.getBounds())}},_addInfoWindowEventListener:function(a,b){},_locationList:function(a){$(this._locationSearchInputSelector).val(a.label)},_loadMarkers:function(){if(this._markersLoaded===false){this._proxy.setOption("data",{className:"poi\\data\\poi\\PoiAction",actionName:"getMapMarkers",parameters:{poiSearch:this._poiSearch,categoryID:this._categoryID}});this._proxy.sendRequest();this._markersLoaded=true;return true}return false},_success:function(e,h,c){this._bounds=new google.maps.LatLngBounds();if(e.returnValues&&e.returnValues.markers){for(var g=0,f=e.returnValues.markers.length;g<f;g++){var a=e.returnValues.markers[g];this.addMarker(a.latitude,a.longitude,a.title,a.icon,a.infoWindow,a.dialog,a.location);this._markerInfoSave.push(a);this._count++;this._usedCategories.push(a.categoryID);this._bounds.extend(new google.maps.LatLng(a.latitude,a.longitude))}}if(f&&Poi.Map.GoogleMaps.Settings.get("centerOnOpen")){this.getMap().fitBounds(this._bounds)}if(this._poiSearch!=""){var d=document.getElementsByName("category");for(var b=0;b<d.length;b++){if(!this._usedCategories.includes(d[g].value)){d[g].disabled=true}}}this._buttonCenter.enable();this._buttonCleanup.enable();this._buttonFilter.enable();this._buttonResetFilter.enable()},addMarker:function(c,a,e,d,f,b,g){var h=$(f).get(0);var i=this._super(c,a,e,d,h);this._markerClusterer.addMarker(i);this._markerSpiderfier.addMarker(i);if(b){}return i.infoWindow}});Poi.Map.GoogleMaps.LocationInput=WCF.Location.GoogleMaps.LocationInput.extend({init:function(f,c,a,g,e,d){this._searchInput=a;if(d){this._map=new WCF.Location.GoogleMaps.SuggestionMap(f,c,d);this._map.setSuggestionSelectionCallback($.proxy(this._useSuggestion,this))}else{this._map=new WCF.Location.GoogleMaps.Map(f,c)}this._locationSearch=new WCF.Location.GoogleMaps.LocationSearch(a,$.proxy(this._setMarkerByLocation,this));if(g&&e){this._marker=this._map.addDraggableMarker(g,e)}else{this._marker=this._map.addDraggableMarker(WCF.Location.GoogleMaps.Settings.get("defaultLatitude"),WCF.Location.GoogleMaps.Settings.get("defaultLongitude"));WCF.Location.Util.getLocation($.proxy(function(i,h){if(i!==undefined&&h!==undefined){WCF.Location.GoogleMaps.Util.moveMarker(this._marker,i,h);WCF.Location.GoogleMaps.Util.focusMarker(this._marker)}},this))}this._marker.addListener("dragend",$.proxy(this._updateLocation,this));this._buttonFind=$(".jsButtonFind");this._buttonFind.click($.proxy(this._find,this));var b=document.getElementById("coordError");b.style.display="none"},_find:function(){var c=document.getElementById("dirLatitude").value;var b=document.getElementById("dirLongitude").value;var a=document.getElementById("coordError");c=parseFloat(c.replace(",","."));b=parseFloat(b.replace(",","."));if(isNaN(c)||isNaN(b)){a.style.display=""}else{a.style.display="none";WCF.Location.GoogleMaps.Util.moveMarker(this._marker,c,b);WCF.Location.GoogleMaps.Util.focusMarker(this._marker);this._updateLocation()}},_updateLocation:function(){WCF.Location.GoogleMaps.Util.reverseGeocoding($.proxy(function(c){if(c!==null){$(this._searchInput).val(c)}},this),this._marker);var b=this._marker.getPosition().lat();var a=this._marker.getPosition().lng();document.getElementById("dirLatitude").value=b.toFixed(5);document.getElementById("dirLongitude").value=a.toFixed(5)},_setMarkerByLocation:function(b){this._marker.setPosition(b.location);WCF.Location.GoogleMaps.Util.focusMarker(this._marker);$(this._searchInput).val(b.label);var c=this._marker.getPosition().lat();var a=this._marker.getPosition().lng();document.getElementById("dirLatitude").value=c.toFixed(5);document.getElementById("dirLongitude").value=a.toFixed(5)}});